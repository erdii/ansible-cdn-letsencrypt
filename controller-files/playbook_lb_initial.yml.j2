---
- hosts: proxies
  user: root
  gather_facts: False
  # become: yes
  # become_method: sudo
  # become_user: root

  tasks:
  - name: install python 2
    raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)


- hosts: proxies
  user: root
  # become: yes
  # become_method: sudo
  # become_user: root
  vars:
    domain: {{ domain }}
    ctrl_fqdn: {{ ctrl_fqdn }}
    worker_user: {{ worker_user }}

  tasks:
  - name: update packages
    apt:
      update_cache: yes

  - name: install nginx
    apt:
      name: nginx
      state: latest

  - name: create www folder
    file:
      mode: 0750
      group: "{{ worker_user }}"
      path: /var/www
      state: directory


  - name: delete nginx default config
    file:
      path: /etc/nginx/conf.d/default
      state: absent
    notify:
      - restart nginx

  - name: delete nginx default config 2
    file:
      path: /etc/nginx/sites-enabled/default
      state: absent
    notify:
      - restart nginx

  - name: copy initial nginx configuration
    template:
      src: proxy-files/nginx/conf.d/without_ssl.conf.j2
      dest: /etc/nginx/conf.d/without_ssl.conf
      owner: root
      mode: 0600
    notify:
      - restart nginx

  - name: enable and start nginx service
    service:
      name: nginx
      state: started
      enabled: yes

  handlers:
  - name: restart nginx
    service:
      name: nginx
      state: reloaded
